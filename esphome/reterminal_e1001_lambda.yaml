# ============================================================================
# reTerminal E1001 - ESPHome Configuration Template
# ============================================================================
# INSTRUCTIONS:
#
# STEP 1: Copy the Material Design Icons font file
#         - From this repo: font_ttf/font_ttf/materialdesignicons-webfont.ttf
#         - To ESPHome: /config/esphome/fonts/materialdesignicons-webfont.ttf
#         (Create the fonts folder if it doesn't exist)
#
# STEP 2: Create a new device in ESPHome
#         - Click "New Device"
#         - Name: reterminal (or your choice)
#         - Select: ESP32-S3
#         - ESPHome will auto-generate a basic config
#
# STEP 3: Copy the "HARDWARE SECTIONS" below (from ▼ START to ▲ END)
#         Paste them AFTER the captive_portal: line in your ESPHome config
#
# STEP 4: Add buzzer services to your api: section (see instructions below)
#
# STEP 5: Design your dashboard in Home Assistant
#         - Open the reTerminal Dashboard integration
#         - Click "Save Layout" when done
#         - Click "Generate Snippet"
#
# STEP 6: From the generated snippet, copy ONLY these sections:
#         - globals:
#         - font:
#         - text_sensor: (only if you used sensor_text widgets)
#         - script: (if generated)
#         - display:
#         Paste them at the end of your config (see STEP 6 marker below)
#
#
# ============================================================================

# ============================================================================
# EXAMPLE: ESPHome Auto-Generated Config (you will have this already)
# ============================================================================
# This is what ESPHome creates automatically. DON'T copy this - it's just
# an example to show you what sections you already have.
#
# esphome:
#   name: reterminal
#   friendly_name: reterminal
#
# IMPORTANT: Add this on_boot section to initialize the display!
esphome:
  name: reterminal-e1001-dashboard
  friendly_name: reTerminal E1001
  # Limit compilation to 1 process to prevent OOM errors with large fonts
  compile_process_limit: 1
  on_boot:
    priority: 600
    then:
      - output.turn_on: bsp_battery_enable
      - delay: 2s
      # - component.update: epaper_display  <-- REMOVED to prevent boot loop with heavy layouts
      - script.execute: manage_run_and_sleep  
#
# esp32:
#   board: esp32-s3-devkitc-1
#   framework:
#     type: esp-idf
#
# logger:
#
# api:
#   encryption:
#     key: "your_auto_generated_key_here"
#
# ota:
#   - platform: esphome
#     password: "your_auto_generated_password_here"
#
# wifi:
#   ssid: !secret wifi_ssid
#   password: !secret wifi_password
#   fast_connect: true      # Recommended for faster connection
#   power_save_mode: NONE   # Recommended for stability
#   ap:
#     ssid: "Reterminal Fallback Hotspot"
#     password: "auto_generated_password"
#
# captive_portal:
#
# ============================================================================


# ============================================================================
# ▼▼▼ START: HARDWARE SECTIONS - COPY FROM HERE ▼▼▼
# ============================================================================
# Copy everything between the ▼▼▼ START and ▲▲▲ END markers
# Paste it in your ESPHome config AFTER the "captive_portal:" line
# ============================================================================

substitutions:
  # Display Settings for reTerminal E1001
  display_model: 7.50inv2
  display_cs_pin: GPIO10
  display_dc_pin: GPIO11
  display_reset_pin: GPIO12
  display_busy_pin: GPIO13

globals:
  # Navigation & Refresh Logic
  - id: display_page
    type: int
    restore_value: true
    initial_value: '0'

  # Default page refresh interval (seconds)
  - id: page_refresh_default_s
    type: int
    restore_value: no
    initial_value: '900'

  # Current computed refresh interval (seconds)
  - id: page_refresh_current_s
    type: int
    restore_value: no
    initial_value: '900'

  - id: battery_glyph
    type: std::string
    restore_value: no
    initial_value: '"\U000F0079"'

# ============================================================================
# PRE-CONFIGURED FONTS
# ============================================================================
# Popular Google Fonts pre-configured for use in the dashboard editor
# ESPHome will automatically download these fonts during compilation
#
# To use these fonts in your widgets, select them from the "Font Family"
# dropdown in the editor's widget properties panel.
#
# ADDING CUSTOM FONTS:
# If you want to use a different Google Font, add it here following this pattern:
#
#   - file:
#       type: gfonts
#       family: YourFontName      # e.g., "Playfair Display"
#       weight: 400                # 100=Thin, 300=Light, 400=Regular, 500=Medium, 600=SemiBold, 700=Bold, 900=Black
#     id: font_yourfont_400_20     # Unique ID: font_<family>_<weight>_<size>
#     size: 20                     # Font size in pixels
#     bpp: 1                       # 1=no anti-aliasing (sharpest), 2=4 levels, 4=16 levels, 8=256 levels
#
# Then add that font family to your editor's font dropdown by editing editor.js
# ============================================================================

# font:
#   # --- REQUIRED ALIASES FOR WIDGETS ---
#   # These generic names are used by widgets like Clock, Graph, and Battery
#   # - file:
#   #     type: gfonts
#   #     family: Roboto
#   #     weight: 700
#   #   id: font_large
#   #   size: 48
#   #   bpp: 1
#   # - file:
#   #     type: gfonts
#   #     family: Roboto
#   #     weight: 400
#   #   id: font_medium
#   #   size: 24
#   #   bpp: 1
#   # - file:
#   #     type: gfonts
#   #     family: Roboto
#   #     weight: 400
#   #   id: font_small
#   #   size: 14
#   #   bpp: 1
# 
#   # Material Design Icons (MDI) - Placeholder fonts for icon widgets
#   # When you generate a snippet, it will include the specific icon glyphs you need
#   # Copy those glyphs into the matching size below, replacing the empty []
#   # - file: fonts/materialdesignicons-webfont.ttf
#   #   id: font_mdi_24
#   #   size: 24
#   #   glyphs: []
#   # - file: fonts/materialdesignicons-webfont.ttf
#   #   id: font_mdi_32
#   #   size: 32
#   #   glyphs: []
#   # - file: fonts/materialdesignicons-webfont.ttf
#   #   id: font_mdi_48
#   #   size: 48
#   #   glyphs: []
#   # - file: fonts/materialdesignicons-webfont.ttf
#   #   id: font_mdi_64
#   #   size: 64
#   #   glyphs: []


  # Roboto - Material Design font (default)
  # - file:
  #     type: gfonts
  #     family: Roboto
  #     weight: 400
  #   id: font_roboto_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Roboto
  #     weight: 400
  #   id: font_roboto_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Roboto
  #     weight: 500
  #   id: font_roboto_500_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Roboto
  #     weight: 700
  #   id: font_roboto_700_20
  #   size: 20
  #   bpp: 1


  # Poppins - Geometric, modern look
  # - file:
  #     type: gfonts
  #     family: Poppins
  #     weight: 400
  #   id: font_poppins_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Poppins
  #     weight: 400
  #   id: font_poppins_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Poppins
  #     weight: 600
  #   id: font_poppins_600_20
  #   size: 20
  #   bpp: 1

  # Open Sans - Clean, professional
  # - file:
  #     type: gfonts
  #     family: Open Sans
  #     weight: 400
  #   id: font_opensans_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Open Sans
  #     weight: 400
  #   id: font_opensans_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Open Sans
  #     weight: 600
  #   id: font_opensans_600_20
  #   size: 20
  #   bpp: 1

  # Montserrat - Geometric sans-serif, great for headings
  # - file:
  #     type: gfonts
  #     family: Montserrat
  #     weight: 400
  #   id: font_montserrat_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Montserrat
  #     weight: 400
  #   id: font_montserrat_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Montserrat
  #     weight: 700
  #   id: font_montserrat_700_20
  #   size: 20
  #   bpp: 1

  # Lato - Warm, friendly sans-serif
  # - file:
  #     type: gfonts
  #     family: Lato
  #     weight: 400
  #   id: font_lato_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Lato
  #     weight: 400
  #   id: font_lato_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Lato
  #     weight: 700
  #   id: font_lato_700_20
  #   size: 20
  #   bpp: 1

  # Source Sans Pro - Adobe's clean sans-serif
  # - file:
  #     type: gfonts
  #     family: Source Sans Pro
  #     weight: 400
  #   id: font_sourcesans_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Source Sans Pro
  #     weight: 400
  #   id: font_sourcesans_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Source Sans Pro
  #     weight: 600
  #   id: font_sourcesans_600_20
  #   size: 20
  #   bpp: 1

  # Nunito - Rounded, friendly
  # - file:
  #     type: gfonts
  #     family: Nunito
  #     weight: 400
  #   id: font_nunito_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Nunito
  #     weight: 400
  #   id: font_nunito_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Nunito
  #     weight: 700
  #   id: font_nunito_700_20
  #   size: 20
  #   bpp: 1

  # Playfair Display - Elegant serif for headings
  # - file:
  #     type: gfonts
  #     family: Playfair Display
  #     weight: 400
  #   id: font_playfair_display_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Playfair Display
  #     weight: 400
  #   id: font_playfair_display_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Playfair Display
  #     weight: 700
  #   id: font_playfair_display_700_20
  #   size: 20
  #   bpp: 1

  # Merriweather - Classic serif, highly readable
  # - file:
  #     type: gfonts
  #     family: Merriweather
  #     weight: 400
  #   id: font_merriweather_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Merriweather
  #     weight: 400
  #   id: font_merriweather_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Merriweather
  #     weight: 700
  #   id: font_merriweather_700_20
  #   size: 20
  #   bpp: 1

  # Raleway - Elegant sans-serif
  # - file:
  #     type: gfonts
  #     family: Raleway
  #     weight: 400
  #   id: font_raleway_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Raleway
  #     weight: 400
  #   id: font_raleway_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Raleway
  #     weight: 600
  #   id: font_raleway_600_20
  #   size: 20
  #   bpp: 1

  # Ubuntu - Modern, humanist sans-serif
  # - file:
  #     type: gfonts
  #     family: Ubuntu
  #     weight: 400
  #   id: font_ubuntu_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Ubuntu
  #     weight: 400
  #   id: font_ubuntu_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Ubuntu
  #     weight: 700
  #   id: font_ubuntu_700_20
  #   size: 20
  #   bpp: 1

  # Work Sans - Optimized for screens
  # - file:
  #     type: gfonts
  #     family: Work Sans
  #     weight: 400
  #   id: font_work_sans_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Work Sans
  #     weight: 400
  #   id: font_work_sans_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Work Sans
  #     weight: 600
  #   id: font_work_sans_600_20
  #   size: 20
  #   bpp: 1

  # Roboto Mono - Monospace variant
  # - file:
  #     type: gfonts
  #     family: Roboto Mono
  #     weight: 400
  #   id: font_roboto_mono_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Roboto Mono
  #     weight: 400
  #   id: font_roboto_mono_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Roboto Mono
  #     weight: 700
  #   id: font_roboto_mono_700_20
  #   size: 20
  #   bpp: 1

  # Quicksand - Rounded, friendly display font
  # - file:
  #     type: gfonts
  #     family: Quicksand
  #     weight: 400
  #   id: font_quicksand_400_14
  #   size: 14
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Quicksand
  #     weight: 400
  #   id: font_quicksand_400_20
  #   size: 20
  #   bpp: 1
  # - file:
  #     type: gfonts
  #     family: Quicksand
  #     weight: 700
  #   id: font_quicksand_700_20
  #   size: 20
  #   bpp: 1

  # Material Design Icons (MDI) - For icon widgets
  # This font is required for the icon widget functionality
  # - file: fonts/materialdesignicons-webfont.ttf
  #   id: font_mdi_24
  #   size: 24
  #   glyphs: []
  # - file: fonts/materialdesignicons-webfont.ttf
  #   id: font_mdi_32
  #   size: 32
  #   glyphs: []
  # - file: fonts/materialdesignicons-webfont.ttf
  #   id: font_mdi_48
  #   size: 48
  #   glyphs: []
  # - file: fonts/materialdesignicons-webfont.ttf
  #   id: font_mdi_64
  #   size: 64
  #   glyphs: []

psram:
  mode: octal
  speed: 80MHz

# Required for Online Image / Puppet widgets
http_request:
  verify_ssl: false
  timeout: 20s

time:
  - platform: homeassistant
    id: ha_time

i2c:
  sda: GPIO19
  scl: GPIO20
  scan: true

spi:
  clk_pin: GPIO7
  mosi_pin: GPIO9

output:
  - platform: gpio
    pin: GPIO21
    id: bsp_battery_enable

  - platform: ledc
    pin: GPIO45
    id: buzzer_output

rtttl:
  id: reterminal_buzzer
  output: buzzer_output

sensor:
  - platform: sht4x
    temperature:
      name: "reTerminal Onboard Temperature"
      id: sensor_reterminal_e1001_reterminal_onboard_temperature
      accuracy_decimals: 2
      filters:
        - round: 2
    humidity:
      name: "reTerminal Onboard Humidity"
      id: sensor_reterminal_e1001_reterminal_onboard_humidity
      accuracy_decimals: 2
      filters:
        - round: 2
    address: 0x44
    update_interval: 60s

  - platform: adc
    pin: GPIO1
    name: "Battery Voltage"
    id: battery_voltage
    update_interval: 60s
    attenuation: 12db
    accuracy_decimals: 2
    filters:
      - multiply: 2.0
      - round: 2

  - platform: template
    name: "Battery Level"
    id: battery_level
    lambda: 'return id(battery_voltage).state;'
    unit_of_measurement: "%"
    device_class: battery
    update_interval: 60s
    accuracy_decimals: 0
    filters:
      - calibrate_linear:
          - 3.27 -> 0.0
          - 4.15 -> 100.0
      - clamp:
          min_value: 0
          max_value: 100
      - round: 0

  - platform: wifi_signal
    name: "WiFi Signal Strength"
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"

binary_sensor:
  - platform: gpio
    id: button_left
    name: "reTerminal Button Left"
    pin:
      number: GPIO5
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      then:
        - lambda: |-
            if (id(display_page) > 0) {
              id(display_page) -= 1;
            }
        - component.update: epaper_display

  - platform: gpio
    id: button_right
    name: "reTerminal Button Right"
    pin:
      number: GPIO4
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      then:
        - lambda: |-
            if (id(display_page) < 9) {
              id(display_page) += 1;
            }
        - component.update: epaper_display

  - platform: gpio
    id: button_refresh
    name: "reTerminal Button Refresh"
    pin:
      number: GPIO3
      mode: INPUT_PULLUP
      inverted: true
    on_press:
      then:
        - component.update: epaper_display

# ... end of binary_sensor section ...


button:
  - platform: template
    name: "Play Beep Short"
    icon: "mdi:bell-ring"
    on_press:
      - rtttl.play: "beep:d=32,o=5,b=200:16e6"

  - platform: template
    name: "Play Beep OK"
    icon: "mdi:check-circle-outline"
    on_press:
      - rtttl.play: "ok:d=16,o=5,b=200:e6"

  - platform: template
    name: "Play Beep Error"
    icon: "mdi:alert-circle-outline"
    on_press:
      - rtttl.play: "error:d=16,o=5,b=200:c6"

  - platform: template
    name: "Play Star Wars"
    icon: "mdi:music-note"
    on_press:
      - rtttl.play: "StarWars:d=4,o=5,b=45:32p,32f,32f,32f,8a#.,8f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32d#,8c6,32p,32f,32f,32f,8a#.,8f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32c,8a#.6,4f.6,32d#,32d,32d#,8c6"

  - platform: template
    name: "reTerminal Next Page"
    id: reterminal_next_page
    on_press:
      - lambda: |-
          int pages = 5;
          id(display_page) = (id(display_page) + 1) % pages;

  - platform: template
    name: "reTerminal Previous Page"
    id: reterminal_prev_page
    on_press:
      - lambda: |-
          int pages = 5;
          id(display_page) = (id(display_page) - 1 + pages) % pages;

  - platform: template
    name: "reTerminal Refresh Display"
    id: reterminal_refresh_display
    on_press:
      - component.update: epaper_display

  - platform: template
    name: "reTerminal Go to Page 1"
    id: reterminal_goto_page_0
    on_press:
      - lambda: 'id(display_page) = 0;'
      - component.update: epaper_display
  - platform: template
    name: "reTerminal Go to Page 2"
    id: reterminal_goto_page_1
    on_press:
      - lambda: 'id(display_page) = 1;'
      - component.update: epaper_display
  - platform: template
    name: "reTerminal Go to Page 3"
    id: reterminal_goto_page_2
    on_press:
      - lambda: 'id(display_page) = 2;'
      - component.update: epaper_display
  - platform: template
    name: "reTerminal Go to Page 4"
    id: reterminal_goto_page_3
    on_press:
      - lambda: 'id(display_page) = 3;'
      - component.update: epaper_display
  - platform: template
    name: "reTerminal Go to Page 5"
    id: reterminal_goto_page_4
    on_press:
      - lambda: 'id(display_page) = 4;'
      - component.update: epaper_display


# ============================================================================
# ▲▲▲ END: HARDWARE SECTIONS - COPY UNTIL HERE ▲▲▲


# ============================================================================
# ▲▲▲ END: HARDWARE SECTIONS - COPY UNTIL HERE ▲▲▲
# ============================================================================


# ============================================================================
# STEP 3: Add buzzer services to your api: section
# ============================================================================
# Find your "api:" section at the top of your config (created by ESPHome)
# It currently looks like this:
#
#   api:
#     encryption:
#       key: "your_key_here"
#
# ADD the "services:" block so it looks like this:
#
#   api:
#     encryption:
#       key: "your_key_here"
#     services:
#       - service: play_tone
#         variables:
#           melody: string
#         then:
#           - rtttl.play: !lambda 'return melody;'
#       - service: beep_short
#         then:
#           - rtttl.play: "beep:d=32,o=5,b=200:16e6"
#       - service: beep_ok
#         then:
#           - rtttl.play: "ok:d=16,o=5,b=200:e6"
#       - service: beep_error
#         then:
#           - rtttl.play: "error:d=16,o=5,b=200:c6"
#
# IMPORTANT: "services:" must be indented at the same level as "encryption:"
# ============================================================================


# ============================================================================
# STEP 5: Paste generated sections from Home Assistant editor
# ============================================================================
# After designing your dashboard:
# 1. Click "Save Layout"
# 3. From the generated code, copy ONLY these sections and paste them below:
#
#    ✓ font:         (always generated)
#    ✓ text_sensor:  (ONLY if you used sensor_text widgets)
#                    If generated, ADD these to the sensor: section above
#                    (don't create a duplicate sensor: section)
#    ✓ button:       (always generated - includes page navigation + buzzer controls)
#    ✓ script:       (always generated for page refresh)
#    ✓ display:      (always generated - complete display configuration)
#
#    ✗ DO NOT COPY from generated code (already in hardware template above):
#      - output:
#      - rtttl:
#      - sensor: (template already has SHT4x sensor)
#      - time:
#
# IMPORTANT: If the generated code includes text_sensor: entries,
# you can paste them here as a separate section. They won't conflict
# with the sensor: section above.
#
# Example of what to paste:
#
#
# font:
#   - file: "gfonts://Material+Design+Icons"
#     id: mdi_48
#     size: 48
#     glyphs: ["\U000F0595"]
#
# text_sensor:
#   - platform: homeassistant
#     id: weather_forecast_home
#     entity_id: weather.forecast_home
#     internal: true
#
# script:
#   - id: manage_run_and_sleep
#     mode: restart
#     then:
#       # ... refresh logic ...
#
# display:
#   - platform: waveshare_epaper
#     id: epaper_display
#     model: ${display_model}
#     cs_pin: ${display_cs_pin}
#     dc_pin: ${display_dc_pin}
#     reset_pin:
#       number: ${display_reset_pin}
#       inverted: false
#     busy_pin:
#       number: ${display_busy_pin}
#       inverted: true
#     update_interval: never
#     lambda: |-
#       int page = id(display_page);
#       if (page == 0) {
#         // your widgets here
#       }
#
# ============================================================================
# ← PASTE YOUR GENERATED CODE HERE (font, text_sensor, script, display)
# ============================================================================
